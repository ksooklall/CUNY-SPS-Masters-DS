---
title: "Data_Project"
author: "Kenan Sooklall"
date: "2/17/2021"
output:
  html_document:
    df_print: paged
  rmdformats::readthedown:
    highlight: kate
---


```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(infer)
library(ggplot2)
library(wordcloud)
library(tidytext)
library(tm)
library(reshape2)
```
https://github.com/kateptrv/Candles/blob/main/Candles%20code%20examples.R

## Abstract
One sign of Covid-19 is often the loss of taste and smell, also known as anosmia, and even those without other symptoms have experienced a loss in those senses. After scraping reviews on protein powder from Amazon.com and looking at the proportion of tasteless or no taste comments before and after 2020 the conclusions are inconclusive. A p value of 25% if outside the range to reject the null hypothesis. However there is a notable increase in the number of reviews and the proportion of comment stating a lack of taste does show an increase. We can say with 95% confidence that a sample of 1000 before 2020 would have between 12-15% (1.56% margin of error) of reviews that state there is no taste or equivalent in their protein powder. While in the year 2020 those reviews increased to 17-21% (1.96% margin of error) of reviews.

## Introduction

Harvard professor Kate Petrova has analyzed sense of smell thorough reviews on scented candles. This report will expand on Professor Petrova research by look at how the sense of taste has changed since the first confirmed cased of Covid-19. The analysis will be done on the protein powders below

1. B000QSNYGI - Optimum Nutrition Gold Standard 100% Whey Protein Powder, Double Rich Chocolate, 5 Pound (Packaging May Vary)

2. B00BEOHFKO - Whey Protein Powder | MuscleTech Phase8 Protein Powder | Whey & Casein Protein Powder Blend | Slow Release 8-Hour Protein Shakes | Muscle Builder for Men & Women | Chocolate, 4.6 lbs (50 Servings)

3. B00NLR1PX0 - Vital Proteins Collagen Peptides Powder Supplement (Type I, III) for Skin Hair Nail Joint - Hydrolyzed Collagen - Non-GMO - Dairy and Gluten Free - 20g per Serving - Unflavored 10 oz Canister

4. B00QQA0H3S - Optimum Nutrition Gold Standard 100% Whey Protein Powder, Naturally Flavored Vanilla, 4.8 Pound (Packaging May Vary)

5. B01NAEHLFO - Garden of Life Sport Certified Grass Fed Clean Whey Protein Isolate, Vanilla, 22.57 Ounce

6. B06XX78LKR - Dymatize ISO 100 Whey Protein Powder with 25g of Hydrolyzed 100% Whey Isolate, Gluten Free, Fast Digesting, 1.6 Pound, Chocolate Peanut Butter, 25.6 Ounce (Pack of 1)

7. B00VZ0IoY8 - Dymatize ISO 100 Whey Protein Powder with 25g of Hydrolyzed 100% Whey Isolate, Gluten Free, Fast Digesting, Brown, Cinnamon Bun, 5 lbs

8. B07BL695D1 - Nutricost Whey Protein Isolate (Strawberry) 5LBS

9. B07L91HBFG - Nutrition Chocolate Milkshake Protein Powder, High Protein, Low Carb, Gluten Free, Soy Free, 1.6 lbs (Pack of 1)

10. B082TTFF87 - KOS Organic Plant Based Protein Powder, Chocolate Peanut Butter - Delicious Vegan Protein Powder - Keto Friendly, Gluten Free, Dairy Free & Soy Free - 1.3 Pounds, 15 Servings

This is an observational study as none of the items were actually purchased and no experiment was conducted.

## Data collection

All of the data in this report were scraped from Amazon.com through product ID. The list above shows the mapping between product ID and protein powder. Ten protein powder were select through random searching and powders that author have sampled as well. To verify the reviews replace {ID} in the link below with one of the ids above.

Link: ''

## Data Preprocessing

```{r, echo=F}
path = '/home/kenan/Documents/learning/masters/CUNY-SPS-Masters-DS/DATA_606/project/'
dfiles = c('B000QSNYGI.csv', 'B00BEOHFKO.csv', 'B00NLR1PX0.csv', 'B00QQA0H3S.csv', 'B01NAEHLFO.csv', 'B06XX78LKR.csv', 'B07BL695D1.csv', 'B07L91HBFG.csv', 'B082TTFF87.csv', 'B00VZ0IoY8.csv')
```

After pulling the html data dates, titles, reviews were all parsed.

```{r}
df = data.frame()

for (i in dfiles) {
  pdf <-  read.csv(paste0(path, i))  
  
  titles = gather(pdf %>% select(starts_with('review_title')))$value
  reviews = gather(pdf %>% select(starts_with('review_text')))$value
  stars = gather(pdf %>% select(starts_with('review_star')))$value
  dates = gather(pdf %>% select(starts_with('review_date')))$value
  pages = gather(pdf %>% select(starts_with('page')))$value
  
  ndf <- data.frame(titles=titles, reviews=reviews, stars=stars, dates=dates, pages=pages) %>%  
          mutate(stars=as.numeric(str_extract(stars, '\\d')),
                 date=str_remove_all(dates, 'Reviewed in the United States on ') %>% as.Date(format = "%b %d, %Y"),
                 years=as.numeric(format(date, format='%Y')),
                 month=as.numeric(format(date, format='%m')),
                 days=as.numeric(format(date, format='%d')),
                 titles=gsub("[\r\n]", "", titles) %>% str_trim(side='both'),
                 protein=str_split(i, '.csv')[[1]][1],
                 reviews=str_to_lower(reviews) %>% gsub(pattern='[[:punct:] ]+', replace=' ') %>% gsub(pattern="[\r\n]", replace=' ') %>% str_trim(side='both'))
  
  df <- bind_rows(df, ndf)
}
```

Reviews required some extra cleaning by removing punctuation and stop words. An iterative process of reading reviews, then updating the stopword list, then rerun and reread was conducted to clean up the reviews.

```{r}
stop_word_list <- c(stopwords(), 'aarp', 'ab', 'azo', 'aug', 'asap', 'just', 'now', 'result', 'try', 'back', 'still', 'know', 'see', 'sure', 'didn', 'got', 'far', 'doesn', 'put', 'can', 'll', 've', 'don', 'much', 'go', 'take', 'use', 'since', 'get', 'always', 'has', 'aa', 'aas', 'will', 'get', 'also')

frequent_words = c('protein', 'product')
df <- df %>% filter(years > 2016 & years <= 2020) %>% 
             mutate(reviews=gsub(pattern='\\b[a-z]\\b{1}', replace=' ', reviews) %>%
                      gsub(pattern='[[:digit:]]+', replace='') %>%
                      removeWords(stop_word_list) %>%
                      str_trim())
```

## Exploratory Data Analysis

### Sentimental Analysis

```{r}
words = df %>% unnest_tokens(word, reviews) %>% count(word, name='word_count')

words %>% filter(word_count > 500 & !(word %in% frequent_words)) %>% mutate(word=reorder(word, word_count)) %>% ggplot(aes(x=word, y=word_count)) + geom_col() + coord_flip()
```

Common words like taste and flavor are used the most as expected, unusual words like hair and collagen were also used. After reading some of the *hair* reviews, the users stated how the protein helped their hair.

```{r}
words %>% inner_join(get_sentiments('afinn')) %>%
          inner_join(get_sentiments('nrc')) %>%
          inner_join(get_sentiments('bing')) %>%
          acast(word ~ sentiment, value.var='word_count', fill=0) %>% 
  comparison.cloud(colors=c('red', 'blue'), max.words = 50)
```

A sentimental analysis was done on the reviews, we see nasty and bad in the negative set and good and perfect in the positive set.


Finally to prepare the data set for analysis we need specific words/phrases that would correspond to the powder having a poor taste or similar. Reviews that contain the *tasteless_words* will be labels as 1 in the *notaste* column else they will be labeled as 0.

```{r}
tasteless_words = c('trash', 
                'disgusting', 
                'horrible', 
                'nasty', 
                'terrible', 
                'abomination', 
                'horrid', 
                'bad', 
                'tasteless', 
                'awful', 
                'flavor awful',
                'gagging',
                'flavor horrible',
                'terrible tasting ',
                'tasted too disgusting',
                'tastes disgusting',
                'taste horrible',
                'tasted horrible',
                'taste horrible',
                'tastes bad',
                'taste unbearable',
                'taste like cheap whey protein',
                'tastes nothing like',
                'taste isnt great',
                'worst after taste',
                'hate taste',
                'worst tasting protein',
                'medicinal and artificial taste',
                'no flavor',
                'not very good taste')

tasteless_words = paste(tasteless_words, sep='|', collapse ='|')[1]
```

protein=recode(protein, 
                        'B000QSNYGI'='Optimum Double Rich Chocolate',
                        'B00BEOHFKO'= 'MuscleTech Phase8',
                        'B00NLR1PX0'= 'Vital Proteins Collagen',
                        'B01NAEHLFO'= 'Garden of Life',
                        'B00VZ0IoY8'= 'Dymatize ISO',
                        'B07BL695D1'='Nutricost Strawberry',
                        'B07L91HBFG'= 'Nutrition Chocolate Milkshake',
                        'B082TTFF87'='KOS Chocolate Peanut Butter'),
                        
```{r}
df <- df %>% mutate(notaste = ifelse(str_detect(reviews, tasteless_words), 1, 0),
                    cyear = ifelse(years <2020, 1, 0))
```

## Before and After Covid-19

```{r}
df  %>% filter(notaste == 1) %>% 
  arrange(date) %>%
  group_by(date) %>%
  summarise(Rating = mean(stars)) %>% ggplot(aes(x = (as.Date(date)), y = Rating)) +
  geom_vline(xintercept = as.numeric(as.Date("2020-01-20")), colour = "red", linetype = "dashed")+
  geom_smooth(method = "loess", size = 1.5, colour = "blueviolet", fill = "blueviolet") +
  geom_point(alpha = 0.5, colour = "chocolate1") +
  geom_text(x=as.Date("2020-05-10"), y=1.5, label='First confirmed\nCovid-19 case', color='black') +
  geom_text(x=as.Date("2017-05-10"), y=1.25, label='N = 570', color='black') +
  labs(x = "Date", y = "Average daily rating (1-5)", title = "Protein Powder Amazon reviews 2017-2020", subtitle = 'Reviews containing lack of taste')+
  theme(plot.title = element_text(size=16)) + 
  scale_x_date(date_labels = "%m-%Y")
```

Before the first case of Covid-19 there is a the regression line is very normal; however after the first confirmed case the line strangely goes up. That motion states there are more positive reviews and those reviews contain a lot of comments on how the powder is lacking taste.


```{r}
df  %>% filter(notaste == 0) %>% 
  arrange(date) %>%
  group_by(date) %>%
  summarise(Rating = mean(stars)) %>% ggplot(aes(x = (as.Date(date)), y = Rating)) +
  geom_vline(xintercept = as.numeric(as.Date("2020-01-20")), colour = "red", linetype = "dashed")+
  geom_smooth(method = "loess", size = 1.5, colour = "blueviolet", fill = "blueviolet") +
  geom_point(alpha = 0.5, colour = "chocolate1") +
  geom_text(x=as.Date("2020-05-10"), y=1.5, label='First confirmed\nCovid-19 case', color='red') +
  geom_text(x=as.Date("2017-05-10"), y=1.25, label='N = 2895', color='black') +
  labs(x = "Date", y = "Average daily rating (1-5)", title = "Protein Powder Amazon reviews 2017-2020", subtitle = 'Reviews containing normal taste')+
  theme(plot.title = element_text(size=16)) + 
  scale_x_date(date_labels = "%m-%Y")
```

The rating distribution for sample that have *notaste* is inline with what we would expect from normal reviews. Those who really like the powder and really hate it will give a review, while those in the middle (2,3,4) are less likely to review.

```{r}
df %>% group_by(stars) %>% summarise(taste=sum(notaste)) %>% ggplot(aes(x=stars, y=taste)) + geom_col()
```

```{r}
df %>% group_by(years) %>% summarise(taste=sum(notaste)) %>% ggplot(aes(x=years, y=taste)) + geom_col()
```

```{r}
df %>% ggplot(aes(x=protein)) + geom_bar() + coord_flip() + facet_wrap(~notaste)
```


```{r}
df %>%
  filter(years == 2020) %>%
  group_by(month) %>%
  add_tally() %>%
  summarise(n =n, notaste = sum(notaste)) %>%
  mutate(nsprop = notaste/n) %>%
  mutate(se = sqrt((nsprop*(1-nsprop))/n)) %>%
  summarise(n=mean(n), se=mean(se), nsprop=mean(nsprop)) %>% 
  ggplot(aes(x=as.factor(month), y = nsprop, group = month))+
  geom_bar(stat = "identity", fill = "lightseagreen")+
  geom_errorbar(aes(ymin = (nsprop-se), ymax = (nsprop+se)), width=0.2, colour = "gray30")+
  labs(x = "Month", y = "Proportion of reviews", title = "Proportion of reviews mentioning lack of taste by month in 2020")+
  theme_light()+
  theme(plot.title = element_text(size=16))
```

Use reviews to predict if there is taste or no taste

## Hypothesis testing

$$ H_o: \mu_{tasteless-before-2020} = \mu_{tasteless-after-2020} \\ Ha: \mu_{tasteless-before-2020} \ne \mu_{tasteless-after-2020}$$
Type 1 Error : Rejecting the null hypothesis when H_o is actually true

Type 2 Error : Failing to reject the null hypothesis when H_a is actually true

### Power analysis

To avoid making a type 1 error we conduct a power analysis

We will use power=0.8, meaning there is an 80% probability that we correctly reject $H_o$ and a threshold for significance $\alpha=0.05$

```{r}
pre_2020 <- df %>% 
  filter(years < 2020) %>% 
  count(notaste) %>%
  mutate(prop=n/sum(n))

p = pre_2020$prop[2]
n = sum(pre_2020$n)
#me <- 1.96 * sqrt(p * (1-p)/n)
```

```{r}
post_2020 <- df %>% 
  filter(years == 2020) %>% 
  count(notaste) %>%
  mutate(prop=n/sum(n))

p = post_2020$prop[2]
n = sum(post_2020$n)
```

Given pre_stdev = 13.9% and post_stdev = 19.5 a sample size of 1390 will be used to achieve the desired parameters.

### Inference on proportions

Success-failure condition

$n * (1-p) \ge 10 $
Before 2020 proportions

```{r}
sample_size = 1390
df %>% filter(years < 2020) %>%
  mutate(notaste=ifelse(notaste == 1, 'yes', 'no')) %>%
  specify(response=notaste, success='yes') %>%
  generate(reps=sample_size, type='bootstrap') %>%
  calculate(stat='prop') %>%
  get_ci(level=0.95)
```


```{r}
df %>% filter(years == 2020) %>%
  mutate(notaste=ifelse(notaste == 1, 'yes', 'no')) %>%
  specify(response=notaste, success='yes') %>%
  generate(reps=sample_size, type='bootstrap') %>%
  calculate(stat='prop') %>%
  get_ci(level=0.95)
```

We can say with 95% confidence that a sample of `r sample_size` before 2020 would have between 12-15% (1.56% margin of error) of reviews that state there is no taste or equivalent in their protein powder. While in the year 2020 that range increases to 17-21% (1.96% margin of error) of reviews.


```{r}
bcvd <- df %>% filter(years < 2020)
bm = mean(bcvd$notaste)
bs = sd(bcvd$notaste)
bn = nrow(bcvd)
```

There are 1901 reviews before 2020, the statistical parameters for the proportion of protein powder that was *tasteless* 

$\mu = 0.139 \\ \sigma=0.346$

```{r}
acvd <- df %>% filter(years == 2020)
am = mean(acvd$notaste)
as = sd(acvd$notaste)
an = nrow(acvd)
```

There are 1901 reviews before 2020, the statistical parameters for the proportion of protein powder that was *tasteless* 

$\mu = 0.195 \\ \sigma=0.396$

```{r}
se = sqrt(bs^2/sqrt(bn) + as^2/sqrt(an))
pe = bm - am

p = pt(pe / se, df=an + bn)
p
```

